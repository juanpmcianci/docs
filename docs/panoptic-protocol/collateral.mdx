---
sidebar_position: 7
---

# Collateral
How does Panoptic calculate collateral requirements

## Collateral tracking

Panoptic uses a collateral tracking system that is similar to margin accounts.
While users can burrow and effectively control up to 5x the amount of collateral they deposited, they cannot withdraw those funds from the Panoptic-Uniswap ecosystem.
All funds are always owned by the Panoptic protocol, but users will 1) collect any fee generated by selling an option and 2) any gain in capital the results from buying an option that becomes in-the-money.

We describe below:
1. Deposit/withdraw collateral in Panoptic
2. The buying power requirement of each option
3. The collateralization ratio that needs to be maintained by an account

### Depositing collateral
Users that interact with the Panoptic protocol for the first time will have to first deposit collateral before they are able to trade any option.
This is done by calling the `deposit(uint128 assets, address token)` function in `PanopticPool.sol`.

The `PanopticPool` smart contract will issues a receipt token (similar to Aave's `aToken` and Compound's `cToken`) which uses a shares model to track yield distribution.
The amount of shares received after depositing `uint128 assets` is computed using the `convertToShares(uint128 assets)` function from `ReceiptBase.sol`:

```solidity
uint256 shares =  (uint256(assets) * totalSupply()) / totalBalance();
```

where `totalSupply()` returns the total amount of receipt token issued and `totalBalance()` returns the amount of token available to withdraw

```solidity
uint256 totalBalance() =
    underlyingToken.balanceOf(panopticPool) -  // total amount in the PanopticPool
    lockedFunds() + // amount of collected fees (protected)
    inAMM(); // amount moved from PanopticPool to UniswapV3Pool (available)
```

Here, the accumulator `lockedFunds()` tracks the amount of fees that have been collected up to that point. 
This amount does not count towards `totalBalance()` because it is reserved to pay the option sellers' premium.

The accumulator `inAMM()` tracks the amount of token that has been moved from the `PanopticPool` to the `UniswapV3Pool`.
This amount *does* count towards `totalBalance()` because it has not left the Panoptic-Uniswap ecosystem.

### Withdrawing collateral
When a user wants to withdraw their tokens out of the Panoptic pool, they have to call `withdraw(uint256 shares, address token, uint256[] calldata positionIdList)`.
Accumulated yields from the deposited collateral will be transferred pro-rata to the user according to the shares model, where:

```solidity
uint128 assets = (shares * totalBalance()) / totalSupply();
```
where `totalBalance()` and `totalSupply()` are computed as described in the [Deposit](/docs/panoptic-protocol/collateral#deposit) section.

The third argument of the `withdraw()` function, `positionIdList`,  must be the list of all positions held by `msg.sender`.
The `positionIdList` will be used to compute the collateral requirement for the account, and will fail if the position will be margin called or underwater (ie. `collateralRequired / collateralBalance < 1`).

