---
sidebar_position: 6
---

# Commissions and Collateral
How does Panoptic calculate collateralization requirements?

## Commission and Collateral Requirements

The commission and the collateralization ratios are computed *after* all funds have moved in/out of the Panoptic pool.

This contrasts with brokerage firms that charge a fixed commission when a position is opened and closed.
When a position expires, however, no commission is paid regardless of if it expired in-the-money or out-the-money.
A consequence of this is that users may keep their position open for longer because they do not want to paid the commission.

In Panoptic, since options never expire and we wanted to limit any that could impact the decision-making when closing a position, commissions are only paid when a new position is minted. 



### Commission Fees

The commission rate is computed from the pool utilization and is paid whenever an option is minted.
The value of the commission to be paid is the `notional value` of the options multiplied by the commission rate.

The commission fee decreases to 20bps at >50% pool utilization and linearly increases to reach 60bps for pool utilization below 10%.

```solidity
COMMISSION
_RATE         ^
              |  max commission = 60bps
     60bps  _ |_____
              |    .¯¯---__
              |    .       ¯¯---__        min commission = 20bps
     20bps  _ |    .              ¯¯---____________________________
              |    .                   .                        .
              +----+-------------------+------------------------+--->   POOL_UTILIZATION
                  10%                 50%                      100%

```

Below is a few examples of the commission fees for various options:


| Uni v3 Pool      | Option type | strike | Position size (token0) | Commission (<10% utilization) |
| ----------- | ----------- |------ | ----------- | ----------- |
| USDC-ETH     | long call | 1/2000 | 2000 USDC  | 12 USDC |
| ETH-USDT   | short put  |  1000   | 1 ETH | 0.006 ETH |
| SHIB-ETH | long put | 1/201,050,000 | 201,050,000 SHIB | 1,206,300 SHIB |
| UNI-ETH   | short strangle | put: 0.004; call:0.01 | 1000 UNI | 0.6 + 0.6 UNI  |
| ETH-OSQTH   | long straddle | put: 10; call:30   | 1 ETH  |  0.006 + 0.006 ETH |

## Collateral tracking

### Depositing collateral
Each account in Panoptic has to deposit collateral in order to mint an option. 
This is done by calling the `deposit(uint128 assets, address token)` function in `PanopticPool.sol`.
The `PanopticPool` smart contract will issues a receipt token (similar to Aave's `aToken` and Compound's `cToken`) which uses a shares model to track yield distribution.

The amount of shares received after depositing `uint128 assets` is computed using the `convertToShares(uint128 assets)` function from `ReceiptBase.sol`:

```solidity
uint256 shares =  (uint256(assets) * totalSupply()) / totalBalance();
```

where `totalSupply()` returns the total amount of receipt token issued and `totalBalance()` returns the amount of token available to withdraw

```solidity
uint256 totalBalance() =
    underlyingToken.balanceOf(panopticPool) -  // total amount in the PanopticPool
    collectedFees() + // amount of collected fees (protected)
    inAMM(); // amount moved from PanopticPool to UniswapV3Pool (available)
```

Here, the accumulator `collectedFees()` tracks the amount of fees that have been collected. 
This amount does not count towards `totalBalance()` because it is reserved to pay options sellers.

The accumulator `inAMM()` tracks the amount of token that has been moved from the PanopticPool to the UniswapV3Pool.
This amount does cound towards `totalBalance()` because it has not left the Panoptic-Uniswap ecosystem.

### Withdrawing collateral
When a user wants to withdraw their tokens out of the Panoptic pool, they have to call `withdraw(uint256 shares, address token, uint256[] calldata positionIdList)`.
Accumulated yields from the deposited collateral will be transferred pro-rata to the user according to the shares model, where:

```solidity
uint128 assets = (shares * totalBalance()) / totalSupply();
```
where `totalBalance()` and `totalSupply()` are computed as described in the [Deposit](/docs/panoptic-protocol/collateral#deposit) section.

The third argument of the `withdraw()` function, `positionIdList`,  must be the list of all positions held by `msg.sender`.
The `positionIdList` will be used to compute the collateral requirement for the account, and will fail if the position will be margin called or underwater (ie. `collateralRequired / collateralBalance < 1`).

## Margin Requirements
Panoptic makes use of built-in leverage to enable the minting of undercollateralized options.
In traditional finance, some accounts like IRA or a Level 1 trading account, requires all options to be fully collateralized.
Specifically, users in IRA accounts can only sell cash-secured puts or covered calls, which means they have to deposit the notional value of the underlying position in cash (for cash-secured puts) or own the underlying shares (for covered calls).

Undercollateralization is handled by reducing the buying power requirement of an asset. 
In the examples above, a Level 4 trading account in a brokerage firm may be able to sell naked puts and naked calls by only posting about 5x less collateral than in a Level 1 account.
For Portfolio margin accounts, the collateral requirements could be even smaller, requiring about 10-15x less collateral than a Level 1 account.

### Buying Power Reduction

The amount of capital available to place trade with is defined by this collateral and is called the *Buying Power*.
For example, if Alice deposits 1500 Dai and 2 ETH the ETH-Dai-30bps Panoptic Pool when the price of ETH is 1500Dai, then her buying power on the put side is 4500 Dai and it is 2.5 ETH on the call side.

The minting of any option in Panoptic will reduce the account's Buying Power. 
The Buying Power Reduction of an option depends on 1) the notional value of that option and 2) the price of the underlying asset and 3) the pool utilization at the time the position was minted. 

Financial Industry Regulatory Authority (FINRA) Rule 4210 (FINRA, 2022) and the Cboe rules (CBOE, 2022) state that the margin account collateral requirements for a short put or a short call are:
```
100% of option proceeds plus 20% of underlying security/index value less out-of-the- money amount, if any, 
to a minimum of option proceeds plus 10% of underlying security/index value for calls; 
10% of the put exercise price for puts. (source: Cboe Rule 10.3)
```



---


### Collateralization ratio (buying)

The collateralization ratio for buying an option is set at a fixed 10% for pool utilization less than 50% and decrease to 5% at 90% or more.


```solidity

BUY
_COLLATERAL
_RATIO        ^
              |   max ratio = 10%
        10% _ |_________________________
              |                         ¯¯---__
              |                        .       ¯¯---__          min ratio = 5%
        5%  - |                        .              ¯¯---________
              |                        .                   .    .
              +------------------------+-------------------+----+--->   POOL_UTILIZATION
                                      50%                 90%   100%

```


### Collateralization ratio (selling)

The collateralization ratio for buying an option is set at a fixed 20% for pool utilization less than 50% and increases to 100% at 90% or more.

```solidity

SELL
_COLLATERAL
_RATIO        ^                                            max ratio = 100%
       100% - |                                            _________
              |                                       __-¯¯.    .
              |                                  __-¯¯     .    .
              |  min ratio = 20%            __-¯¯          .    .
        20% _ |_________________________--¯¯               .    .
              |                        .                   .    .
              +------------------------+-------------------+----+--->   POOL_UTILIZATION
                                    50%                   90%   100%

```

### Buying Power Requirement (buying)

The buying power requirement for buying an option is simply: `BPR = BUY_COLLATERAL_RATIO * NOTIONAL_VALUE + ACCUMULATED_LONG_PREMIUM`

### Buying Power Requirement (selling)

The buying power requirement (BPR) for selling an option is :


BPR for puts (with collateral denominated in numeraire):

```solidity
                                        .
BUYING                                  .
_POWER                         <- ITM   .  OTM ->
_REQUIREMENT                            .
              ^                         .
       100% - |-__    BPR = 100% - (100% - SCR)*(price/strike)
              |   ¯¯--__                .
              |         ¯¯--__          .
              |               ¯¯--__    .            min BRP = SELL_COLLATERAL_RATIO
        SCR - |                     ¯¯--________________________________
              |                         .
              +-------------------------+--------------------------->   current price
              0                      strike

```

BPR for calls (with collateral denominated in numeraire):

```solidity

BUYING                     .                                              __-- >100%
_POWER                     .                                        __--¯¯
_REQUIREMENT       <- OTM  .  ITM ->                          __--¯¯
              ^            .                            __--¯¯
       100% - |  -   -   - . -   -   -   -   -   -__--¯¯  -   -   -   -   -   - 100%
              |            .                __--¯¯  .
              |            .          __--¯¯        .
              | min BRP    .    __--¯¯       BPR = SCR + (100% - SCR)*(price/strike - 1)
 SELL_RATIO _ |_____________--¯¯                    .
              |            .                        .
              +------------+------------------------+--------------->   current price
              0         strike                 2 * strike

```

The buying power requirement of a call can exceed the notional value of the minted option.
However, users can deposit the asset as collateral in order to mitigate those risks.


The buying power requirement of a call can exceed the notional value of the minted option.
However, users can deposit the asset as collateral in order to mitigate those risks.



BPR for calls (with collateral denominated in asset):
```solidity

BUYING                     .
_POWER                     .
_REQUIREMENT       <- OTM  .  ITM ->
              ^            .
       100% - |  -   -   - . -   -   -   -   -   -   -   -   -   -___----- 100%
              |            .               ______-------¯¯¯¯¯¯¯¯¯¯
              |            .   ___----¯¯¯¯¯
              | min BRP    . --      BPR = 100% - (100% - SCR)*(strike/price)
 SELL_RATIO _ |_____________¯
              |            .
              +------------+---------------------------------------->   current price
              0         strike

```

